---
title: "Process model results to generate results in article"
author: "Amy Heather"
---

This script assumes you have already run the scenarios in `models/` and saved those results to `.csv` files which we here then process to generate the results from the paper.

## Set-up

```{r}
library(dplyr)
```

```{r}
# Path to output folder
outputs = "../output"

# Paths to output files
paths <- list(
  y65_s1_1m = file.path(outputs, "output_65yo_scen1_1mil.csv"),
  y65_s1_2m = file.path(outputs, "output_65yo_scen1_2mil.csv"),
  tab2 = file.path(outputs, "tab2.csv")
)
```

```{r}
# Import files
y65_s1_1m <- read.csv(paths$y65_s1_1m)
y65_s1_2m <- read.csv(paths$y65_s1_2m)

# Preview 65 year old scenario 1 dataframe with 1 million people
head(y65_s1_1m, 3)
```

## Table 2

```{r}
make_tab2 <- function(df, n_person) {
  #' Create table 2 from the article
  #' 
  #' @param df Dataframe with results from the model
  #' @param n_person Integer - number of people in simulation

  full_tab2 <- df %>%
    # Sort by length of delay (so first row is 0 delay)
    arrange(delayscr) %>%
    mutate(total_emer = emerevar + emeropen) %>%
    select(delayscr, aaadead, total_emer) %>%
    # Scale to number of deaths if population size was 279,798
    mutate(scaled_dead = round(279798*(aaadead/n_person)),
           scaled_emer = round(279798*(total_emer/n_person))) %>%
    # Calculate excess (compare to time 0, but set negative to 0)
    mutate(excess_dead = pmax(scaled_dead - first(scaled_dead), 0),
           excess_emer = pmax(scaled_emer - first(scaled_emer), 0))

  # Filter and format to match paper
  tab2 <- full_tab2 %>%
    # Just keep a subset of results
    filter(delayscr %in% c(0.5, 1, 2, 3, 4, 5)) %>%
    # Convert time from years to months
    mutate(months = paste0(delayscr*12, "m")) %>%
    select(months, excess_dead, excess_emer)

  return(list(full_tab2, tab2))
}
```

Simulation 65yo scen1 with 1,000,000 people

```{r}
make_tab2(y65_s1_1m, 1000000)
```

Simulation 65yo scen1 with 2,000,000 people

```{r}
make_tab2(y65_s1_2m, 2000000)
```
