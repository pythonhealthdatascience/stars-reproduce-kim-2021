<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.55">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Amy Heather">
<meta name="dcterms.date" content="2024-07-29">

<title>Day 2 – Reproducing Kim et al.&nbsp;2021</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<link href="../../../quarto_site/stars_logo_blue.png" rel="icon" type="image/png">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../../quarto_site/stars_logo_blue.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">Reproducing Kim et al.&nbsp;2021</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../quarto_site/study_publication.html"> 
<span class="menu-text">Original study</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-reproduction" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Reproduction</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-reproduction">    
        <li>
    <a class="dropdown-item" href="../../../quarto_site/reproduction_readme.html">
 <span class="dropdown-text">README</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-evaluation" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Evaluation</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-evaluation">    
        <li>
    <a class="dropdown-item" href="../../../evaluation/scope.html">
 <span class="dropdown-text">Scope</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../evaluation/reproduction_success.html">
 <span class="dropdown-text">Reproduction success</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../evaluation/badges.html">
 <span class="dropdown-text">Journal badges</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../evaluation/artefacts.html">
 <span class="dropdown-text">STARS framework</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../evaluation/reporting.html">
 <span class="dropdown-text">Reporting guidelines</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../../../logbook/logbook.html"> 
<span class="menu-text">Logbook</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../evaluation/reproduction_report.html"> 
<span class="menu-text">Summary</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../evaluation/reflections.html"> 
<span class="menu-text">Reflections</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/pythonhealthdatascience/stars-reproduce-kim-2021/"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Day 2</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">read</div>
                <div class="quarto-category">scope</div>
                <div class="quarto-category">reproduce</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Amy Heather </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">July 29, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#high-entropy-secret" id="toc-high-entropy-secret" class="nav-link active" data-scroll-target="#high-entropy-secret">09.38-09.43: High entropy secret</a></li>
  <li><a href="#correct-file-paths" id="toc-correct-file-paths" class="nav-link" data-scroll-target="#correct-file-paths">09.53-09.55: Correct file paths</a></li>
  <li><a href="#read-journal-article" id="toc-read-journal-article" class="nav-link" data-scroll-target="#read-journal-article">10.05-10.15, 10.29-10.45: Read journal article</a></li>
  <li><a href="#define-scope-for-reproduction" id="toc-define-scope-for-reproduction" class="nav-link" data-scroll-target="#define-scope-for-reproduction">10.46-11.02: Define scope for reproduction</a></li>
  <li><a href="#discussed-scope-with-tom" id="toc-discussed-scope-with-tom" class="nav-link" data-scroll-target="#discussed-scope-with-tom">11.09-11.13: Discussed scope with Tom</a></li>
  <li><a href="#archive-scope" id="toc-archive-scope" class="nav-link" data-scroll-target="#archive-scope">11.26-11.32 : Archive scope</a></li>
  <li><a href="#look-over-code" id="toc-look-over-code" class="nav-link" data-scroll-target="#look-over-code">12.50-12.56: Look over code</a></li>
  <li><a href="#set-up-environment" id="toc-set-up-environment" class="nav-link" data-scroll-target="#set-up-environment">12.57-13.04: Set up environment</a></li>
  <li><a href="#trying-to-run-model" id="toc-trying-to-run-model" class="nav-link" data-scroll-target="#trying-to-run-model">13.05-13.13, 13.48-13.55, 14.07-14.21, 14.53-15.08: Trying to run model</a></li>
  <li><a href="#running-the-model-with-fewer-people" id="toc-running-the-model-with-fewer-people" class="nav-link" data-scroll-target="#running-the-model-with-fewer-people">15.09-15.42: Running the model with fewer people</a></li>
  <li><a href="#inspecting-outcome-from-a-model-run" id="toc-inspecting-outcome-from-a-model-run" class="nav-link" data-scroll-target="#inspecting-outcome-from-a-model-run">15.43-16.00, 16.03-16.43, 16.45-16.47, 16.53-16.56: Inspecting outcome from a model run</a></li>
  <li><a href="#timings" id="toc-timings" class="nav-link" data-scroll-target="#timings">Timings</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/pythonhealthdatascience/stars-reproduce-kim-2021/edit/main/logbook/posts/2024_07_29/index.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/pythonhealthdatascience/stars-reproduce-kim-2021/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Read article, decided on scope, then began running model. Total time used: 4h 3m (10.1%).</p>
</div>
</div>
<section id="high-entropy-secret" class="level2">
<h2 class="anchored" data-anchor-id="high-entropy-secret">09.38-09.43: High entropy secret</h2>
<p>Upload of code to repository triggered a notification from GitGuardian for upload of a high entropy secret. Opening the GitGuardian dashboard, I found the source of this issue was an API key uploaded to <code>original_study/AAA_DES_model/input/NAAASP_Men_2020-05-11/DES_Data_Input_NAAASP_Men_30years_time_horizon_2020-05-11.R</code> on line 376:</p>
<p><code># SOURCE: Love-Koh 2015 (https://reader.elsevier.com/reader/sd/pii/S1098301515018471?token=AB11057F469D57EBE990778CCDC883E9D35D3CFD83AD143352F3AD497E822198F957DBCE2EA86AE6DC16F2F6CE350409)</code></p>
<p>This is not a concern - the link doesn’t work with that token for others.</p>
<p>The DOI for this article is <a href="https://doi.org/10.1016/j.jval.2015.03.1784" class="uri">https://doi.org/10.1016/j.jval.2015.03.1784</a>.</p>
</section>
<section id="correct-file-paths" class="level2">
<h2 class="anchored" data-anchor-id="correct-file-paths">09.53-09.55: Correct file paths</h2>
<p>For <code>study_publication.qmd</code>.</p>
</section>
<section id="read-journal-article" class="level2">
<h2 class="anchored" data-anchor-id="read-journal-article">10.05-10.15, 10.29-10.45: Read journal article</h2>
<p>Uses a previously developed and validated model described in:</p>
<ul>
<li>Glover MJ, Jones E, Masconi KL, Sweeting MJ, Thompson SG. Discrete Event Simulation for Decision Modeling in Health Care: Lessons from Abdominal Aortic Aneurysm Screening. Med Decis Making. 2018; 38(4):439–51. <a href="https://doi.org/10.1177/0272989X17753380" class="uri">https://doi.org/10.1177/0272989X17753380</a> PMID: 31665967</li>
<li>Thompson SG, Bown MJ, Glover MJ, Jones E, Masconi KL, Michaels JA, et al.&nbsp;Screening women aged 65 years or over for abdominal aortic aneurysm: a modelling study and health economic evaluation. Health Technol Assess. 2018; 22(43):1–142. <a href="https://doi.org/10.3310/hta22430" class="uri">https://doi.org/10.3310/hta22430</a> PMID: 30132754</li>
</ul>
<p>Some notes on scope (beyond obvious tables/figures):</p>
<ul>
<li>In-text result for <code>Surveillance cohort: Scan suspension</code> (re: breakdown of deaths by type) are not captured in tables/figures</li>
<li>Supplementary figure 1 and 2 are more like methods than results? Are referenced in methods.</li>
<li>In-text results for <code>Surveillance cohort: Drop-out</code> are captured in Table 3 and Figure 4</li>
<li>Also captured are <code>Surveillance cohort: Threshold for surgery</code></li>
<li>Supplementary figure 3 and supplementary table 2 are definitely in scope</li>
</ul>
</section>
<section id="define-scope-for-reproduction" class="level2">
<h2 class="anchored" data-anchor-id="define-scope-for-reproduction">10.46-11.02: Define scope for reproduction</h2>
<p>I described my interpretation of scope within <code>scope.qmd</code>.</p>
</section>
<section id="discussed-scope-with-tom" class="level2">
<h2 class="anchored" data-anchor-id="discussed-scope-with-tom">11.09-11.13: Discussed scope with Tom</h2>
<p>Looked over and happy with scope. He then did another look over the paper, but confirmed no further items.</p>
</section>
<section id="archive-scope" class="level2">
<h2 class="anchored" data-anchor-id="archive-scope">11.26-11.32 : Archive scope</h2>
<p>Update <code>CHANGELOG.md</code> and <code>CITATION.cff</code>, set up sync on Zenodo, then created a Git release.</p>
</section>
<section id="look-over-code" class="level2">
<h2 class="anchored" data-anchor-id="look-over-code">12.50-12.56: Look over code</h2>
<p>README:</p>
<ul>
<li>Directs to <code>NAASP_DES_Example_Script.R</code> which provides walk through example for running model.</li>
<li>Notes the repository contains code for two papers - we are interested in <code>NAAASP_COVID</code> (rather than <code>SWAN</code>)</li>
</ul>
<p>Copied the items relevant to NAAASP COVID into <code>reproduction/</code>. As README states results are saved to <code>output/</code>, <strong>create a placeholder output folder</strong></p>
<p>The <code>models/</code> folder seems to contain scripts to run each of the scenarios.</p>
</section>
<section id="set-up-environment" class="level2">
<h2 class="anchored" data-anchor-id="set-up-environment">12.57-13.04: Set up environment</h2>
<p>Based on experience trying to backdate R and packages in my previous reproduction (<a href="https://pythonhealthdatascience.github.io/stars-reproduce-huang-2019/logbook/posts/2024_07_05/">Huang et al.&nbsp;2019</a>), I decided that this time I would start with the latest R and packages, and then backdate if its not working.</p>
<p>This means using R 4.4.1 (paper mentions 3.6.3).</p>
<p>At the start of each script, it lists the packages to be installed (though not versions). Created a DESCRIPTION file with these packages.</p>
<pre><code>Title: Computational reproducibility assessment of Kim et al. 2019
Depends: 
    R
Imports:
    Rcpp,
    expm,
    msm,
    foreach,
    iterators,
    doParallel</code></pre>
<p>Ran:</p>
<pre><code>renv::init(bare=TRUE)
renv::install()
renv::snapshot()</code></pre>
</section>
<section id="trying-to-run-model" class="level2">
<h2 class="anchored" data-anchor-id="trying-to-run-model">13.05-13.13, 13.48-13.55, 14.07-14.21, 14.53-15.08: Trying to run model</h2>
<p>Tried running <code>run_aaamodel_65yo_scen0.R</code>. Had error:</p>
<pre><code>this.dir &lt;- dirname(parent.frame(2)$ofile)
Error in dirname(parent.frame(2)$ofile) : 
  a character vector argument expected</code></pre>
<p>Realised this has a comment above stating:</p>
<pre><code># Set the working directory to the root directory of AAA_DES_model (can only run this if sourcing the file)</code></pre>
<p>So instead tried running with <code>Source</code> - this worked, up until this line:</p>
<pre><code>&gt; v1other
postSurgeryInitialPeriod = 0.08213552 
timeToMonitoringFollowingOpenSurgery = 0.1149897 
timeBetweenMonitoringFollowingEvarSurgery = 1 
zeroGrowthDiameterThreshold = 2 
baselineDiameters = data.frame with 2 columns:
  size = 0.7 0.8 0.9 1 1.1 1.2 1.3 1.4 ...
  weight = 2.86e-06 5.71e-06 4.43e-05 0.000351429 0.001205714 0.005032857 0.017921429 0.045698572 ...
prevalenceThreshold = 3 
aortaDiameterThresholds = list: =Error in cat(names(element)[i], "=", element[[i]], " ", sep = "") : 
  argument 3 (type 'list') cannot be handled by 'cat'</code></pre>
<p><code>v1other</code> was created when we called <code>source("input/NAAASP_Men_2020-05-11/DES_Data_Input_NAAASP_Men_30years_time_horizon_2020-05-11.R")</code>. Looking at that script, aortaDiameterThresholds are set as <code>v1other$aortaDiameterThresholds &lt;- list(c(3.0, 4.5, 5.5))</code>. Viewing the object rather than printing it with <code>View(v1other)</code>, I can see that the thresholds are stored, but its just a list within a list.</p>
<p>I tried commenting the print statement in <code>run_aaamodel...</code> but this just led to a later error for the same variable when it is used. As such, I instead altered assignment of this variable in the sourced script to <code>c(3.0, 4.5, 5.5)</code> (removing <code>list()</code>).</p>
<p>This then ran without issue. As it ran, I can see it sets a random seed (<code>set.seed(3210)</code>). As per usual, paused timing while it ran.</p>
<p>Spent a long while on <code>processPersons()</code> (<code>scen0.invite &lt;- processPersons(v0, v1other, v2, personData.screen)</code>). At 13.48 (with model running since 13.13), I could see these would likely be slow models to run, so logged into the remote computer, cloned the GitHub repository there, and ran the next script starting at 13.55, <code>run_aaamodel_65yo_scen0.R</code>. To do so, after cloning, I ran:</p>
<pre><code>cd stars-reproduce-kim-2021/reproduction
Rscript -e "renv::restore()"
Rscript -e "source('models/NAAASP_COVID_modelling/run_aaamodel_65yo_scen1.R')"</code></pre>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Reflection
</div>
</div>
<div class="callout-body-container callout-body">
<p>Including the expected run time would be handy, as I assume this is working fine, but that’s working on the assumption that these models take a long time to run (which I’m not sure yet whether that is the case or not).</p>
<p>In this case, as I later found out they used HPC, it would’ve been beneficial to mention that also!</p>
</div>
</div>
<p>I checked the <code>run_aaamodel...</code> scripts and realised that in each, none were using parallel processing (as <code>v0$method &lt;- "serial"</code>).</p>
<p>Looking at the DES_Model code I can see the example of <code>processPersons()</code> allows three possible inputs:</p>
<ul>
<li>“serial”</li>
<li>“parallel” (which uses parallel)</li>
<li>“foreach” (which uses doParallel)</li>
</ul>
<p>The function <code>psa()</code> is the same, but also includes “parallelBatches” alongside “foreach”. However, the consequence of those inputs is to return an error that the method has not been implemented for psa. Hence, psa can only run with “serial” or “parallel”. Likewise for <code>psaAboveDiagnosisThreshold()</code>.</p>
<p>At 14.16 (so having let the model run since 13.55, for 21 minutes), I cancelled the run on the remote computer, and altered the scenario script to set <code>v0$method &lt;- "parallel"</code>. Then set that running, starting at 14.21. At this moment, the first scenario was still running on my machine (since 13.13, so for apx. 1h 10m now).</p>
<p>At 14.39, I noticed the parallel model said <code>Killed</code>. In case I might have accidentally done this, I just set it to rerun again. However, at 14.52, it showed as <code>Killed</code> again. Upon Googling, I can see this message occurs when you run out of memory - which perhaps, might be why all were set to run sequentially, if its too intensive to run in parallel. I switched it back to “serial”.</p>
<p>However, the model still running on my machine has now been going for 1h 42m. Having looked in the repository and article for any indication of runtime or requirement of HPC, I’ve yet to find anything. I tried looking now at the article first describing the model (<a href="https://doi.org/10.1177/0272989X17753380" class="uri">https://doi.org/10.1177/0272989X17753380</a>). In this article, they state the run time:</p>
<pre><code>However, the computational requirements of the DES were extensive, given the number of individuals needed to reduce sampling variation to an acceptable level and characterizing uncertainty through PSA. Run time was in the region of 24 h to run the model with 500,000 patients and 1,000 PSA iterations, even with parallelization and the use of a high-powered computer.</code></pre>
<p>In this case, “each scenario model is run for 10 million hypothetical individuals randomly drawn with replacement from the distribution of the relevant population. The models are run for a period of 30 years”. However, as there is no mention of performing probabilistic sensitivity analysis iterations in the article, we could expect this to be quicker than that (although note it is 10m patients instead of 500k).</p>
<p>Discussed with Tom and agreed to:</p>
<ul>
<li><ol type="A">
<li>Try and just run it with very few people, just so we can see if the model is working, and whether we could get similar results with fewer people in the model</li>
</ol></li>
<li><ol start="2" type="A">
<li>Try and run it sequentially on the remote computer overnight</li>
</ol></li>
</ul>
</section>
<section id="running-the-model-with-fewer-people" class="level2">
<h2 class="anchored" data-anchor-id="running-the-model-with-fewer-people">15.09-15.42: Running the model with fewer people</h2>
<p><code>DES_Input_Definitions</code> states that the number of people to run through the DES is defined by <code>v0$numberOfPersons</code>, default 1000. Can see in <code>run_aaamodel_65yo_scen0.R</code> that it has been set to <code>v0$numberOfPersons &lt;- 1e7</code>. I replaced this with <code>v0$numberOfPersons &lt;- 1000</code>. This finished almost immediately, then hit an error:</p>
<pre><code>&gt; TableOfCounts(scen0.invite, v1other)
Error in "screen" %in% eventHistory$events &amp;&amp; !("nonvisualization" %in%  : 
  'length = 3' in coercion to 'logical(1)'</code></pre>
<p><code>TableOfCounts()</code> is from <code>DES_Model.R</code>. Working through each line of the function, I found that the error is occurring for <code>scre_dropout=countDropouts(result, v1other)</code>.</p>
<p>In this function, <code>personsInfo</code> (<code>result</code>, ie. <code>scen0.invite</code>) is used. It loops through the <code>EventHistories</code> for each person: <code>for (i in 1:length(personsInfo$eventHistories))</code>. It checks whether their events:</p>
<ul>
<li>Includes “screen” (<code>"screen" %in% eventHistory$events</code>)</li>
<li>Does not include “nonvisualization” (<code>!("nonvisualization" %in% eventHistory$events)</code>)</li>
<li>If the measured size for screen is greater than or equal to <code>v1other$aortaDiameterThresholds[[1]]</code></li>
</ul>
<p>The error occurs for that final comparison. That is the item we had to change earlier to be able to get the model to run. I tried setting that back to being a list within a list - <code>v1other$aortaDiameterThresholds &lt;- list(c(3.0, 4.5, 5.5))</code>. However, I realised that <em>caused</em> the issue, and that in fact, <code>run_aaamodel_65yo_scen0.R</code> is changing it to <code>list()</code> again before running the model:</p>
<pre><code>## Change v1other$aortaDiameterThresholds to be a list (new syntax)
v1other$aortaDiameterThresholds &lt;- list(v1other$aortaDiameterThresholds)</code></pre>
<p>If I comment out that line, an error occurs. Hence, it seems we require it to be in a list within a list for the model, but just a list for <code>TableOfCounts()</code>. Looking at all the repository code, the reason becomes apparent in <code>models/NAASP_COVID_modelling/run_aaamodel_surv_scen3.R</code>, when multiple aaortaDiameterThresholds are provided.</p>
<p>As such, I set about modifying the later processing functions so that they are able to use this <code>list()</code> format:</p>
<ul>
<li><code>input/NAAASP_Men_2020-05-11/DES_Data_Input_NAAASP_Men_30years_time_horizon_2020-05-11.R</code>: returned back to list(c()), but then changed <code>run_aaamodel_65yo_scen0.R</code> to not add an additional list() over the top.</li>
<li><code>DES_Model.R</code>: <code>countDropouts()</code>: <code>&gt;= v1other$aortaDiameterThresholds[[1]]</code> to <code>&gt;= v1other$aortaDiameterThresholds[[1]][1]</code></li>
</ul>
<p>The whole script then ran successfully!</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Reflection
</div>
</div>
<div class="callout-body-container callout-body">
<p>These errors will likely be the result of having modified code but no re-run everything from scratch (unsurprising given the anticipated model run times).</p>
</div>
</div>
</section>
<section id="inspecting-outcome-from-a-model-run" class="level2">
<h2 class="anchored" data-anchor-id="inspecting-outcome-from-a-model-run">15.43-16.00, 16.03-16.43, 16.45-16.47, 16.53-16.56: Inspecting outcome from a model run</h2>
<p>That R script ran the status quo (I0) scenario for invited 65 year olds. The parameters from Table 1 are below, along with their location in the data from <code>DES_Input_Definitions.xlsx</code></p>
<ul>
<li>Attendance 75% - <code>v2$probOfAttendScreen</code></li>
<li>Drop-out rate/annum: 6% - <code>v2$rateOfDropoutFromMonitoring</code></li>
<li>Threshold for surgery: 5.5cm - <code>v1other$aortaDiameterThresholds[[1]][3]</code> (“These are the aortic cut-points where surveillance intervals change. Note, the first cut-point must always relate to the aortic size where individuals enter the AAA surveillance programme (e.g.&nbsp;3.0cm). The last cut-point must always relate to the aortic size where surgery is to be considered (e.g.&nbsp;5.5cm)”)</li>
</ul>
<p>Looking at the next R script, <code>run_aaamodel_65yo_scen1.R</code>, I can see that they repeat the model multiple times to get results from varying parameters of that scenario. That script is scenario 1 which, from Table 1, we can see delays invitation from 3 months to 5 years.</p>
<p>I switched to trying that script, but again first setting:</p>
<ul>
<li><code># v1other$aortaDiameterThresholds &lt;- list(v1other$aortaDiameterThresholds)</code></li>
<li><code>v0$numberOfPersons &lt;- 1000</code></li>
</ul>
<p>This ran eight “scenarios” within the script. The output dataframe <code>scen1summaryi</code> showed the results from each of those eight variants. I add a line to the script to save this to csv. However, I could see that the number dead was 7 or 8 across all scenarios, so we likely did need to up the number in the model a bit more to start getting some real results.</p>
<div id="368177cb" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> pd.read_csv(<span class="st">'output_65yo_scen1_n1000.csv'</span>)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>res[[<span class="st">'delayscr'</span>, <span class="st">'aaadead'</span>]].sort_values(by<span class="op">=</span><span class="st">'delayscr'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">delayscr</th>
<th data-quarto-table-cell-role="th">aaadead</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">7</td>
<td>0.00</td>
<td>7</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">0</td>
<td>0.25</td>
<td>7</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1</td>
<td>0.50</td>
<td>7</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2</td>
<td>1.00</td>
<td>7</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3</td>
<td>2.00</td>
<td>7</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">4</td>
<td>3.00</td>
<td>7</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">5</td>
<td>4.00</td>
<td>8</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">6</td>
<td>5.00</td>
<td>8</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>I increased it to 10,000 patients. For each of the eight runs in the script, it took about 27 seconds (so under four minutes in total). Here we start to see more change between each scenario, and it becomes more feasible to look at the results.</p>
<div id="f0d0797d" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> pd.read_csv(<span class="st">'output_65yo_scen1_n10000.csv'</span>)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>res[[<span class="st">'delayscr'</span>, <span class="st">'aaadead'</span>, <span class="st">'emeropen'</span>]].sort_values(by<span class="op">=</span><span class="st">'delayscr'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="2">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">delayscr</th>
<th data-quarto-table-cell-role="th">aaadead</th>
<th data-quarto-table-cell-role="th">emeropen</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">7</td>
<td>0.00</td>
<td>96</td>
<td>33</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">0</td>
<td>0.25</td>
<td>96</td>
<td>33</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1</td>
<td>0.50</td>
<td>98</td>
<td>32</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2</td>
<td>1.00</td>
<td>96</td>
<td>31</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3</td>
<td>2.00</td>
<td>98</td>
<td>31</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">4</td>
<td>3.00</td>
<td>98</td>
<td>32</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">5</td>
<td>4.00</td>
<td>101</td>
<td>32</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">6</td>
<td>5.00</td>
<td>103</td>
<td>32</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Each result here relates to Table 2 (i.e.&nbsp;excess AAA deaths, and excess emergency operations). To calculate excess, given that the results appears to increment from the first 0 scenario, I’m assuming that this is the change in deaths from the 0 scenario.</p>
<p>I created an .Rmd file to start processing the results. This required the addition of <strong>rmarkdown</strong> to the renv. I add dplyr for processing the results. Looking at excess deaths, we can see the anticipated pattern, although for emergency operations, the numbers are still too small that they fluctuate, and emergency operations goes in the wrong direction.</p>
<div id="4e676274" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>pd.read_csv(<span class="st">'tab2.csv'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">delayscr</th>
<th data-quarto-table-cell-role="th">excess_death</th>
<th data-quarto-table-cell-role="th">excess_op</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0.00</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0.25</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0.50</td>
<td>2</td>
<td>-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>1.00</td>
<td>0</td>
<td>-2</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>2.00</td>
<td>2</td>
<td>-2</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>3.00</td>
<td>2</td>
<td>-1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>4.00</td>
<td>5</td>
<td>-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>5.00</td>
<td>7</td>
<td>-1</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>I tried upping it to 100,000 people, and recorded the time with different settings:</p>
<ul>
<li>“serial” - <strong>5 minutes 7 seconds</strong></li>
<li>“parallel” - <strong>2 minutes 12 seconds</strong> (although 1m10 of that was just it getting set up it seems, as the line <code>Random seed has been set by clusterSetRNGStream(iseed=3210).</code>)</li>
<li>“foreach” - not possible, <code>Error in processPersons(v0, v1other, v2, personData.screen) : v0$randomSeed does not yet work with v0$method="foreach"</code></li>
</ul>
<p>For each of these, about 45 seconds is results processing at the end (e.g.&nbsp;<code>Eventsandcosts()</code>)</p>
<p>Whilst these ran, I looked through the repository to try and spot whether they had functions to generate the plots from the article. I found plotting functions in <code>DES_Model.R</code>, <code>shiny_output_functions.R</code> and <code>NAAASP_DES_Example_Script.R</code>, though none relevant to the article, so it appears I’ll need to write the code to do that processing.</p>
</section>
<section id="timings" class="level2">
<h2 class="anchored" data-anchor-id="timings">Timings</h2>
<div id="29c9419f" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>sys.path.append(<span class="st">'../'</span>)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> timings <span class="im">import</span> calculate_times</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Minutes used prior to today</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>used_to_date <span class="op">=</span> <span class="dv">32</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Times from today</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>times <span class="op">=</span> [</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'09.38'</span>, <span class="st">'09.43'</span>),</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'09.53'</span>, <span class="st">'09.55'</span>),</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'10.05'</span>, <span class="st">'10.15'</span>),</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'10.29'</span>, <span class="st">'10.45'</span>),</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'10.46'</span>, <span class="st">'11.02'</span>),</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'11.09'</span>, <span class="st">'11.13'</span>),</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'11.26'</span>, <span class="st">'11.32'</span>),</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'12.50'</span>, <span class="st">'12.56'</span>),</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'12.57'</span>, <span class="st">'13.04'</span>),</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'13.05'</span>, <span class="st">'13.13'</span>), </span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'13.48'</span>, <span class="st">'13.55'</span>),</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'14.07'</span>, <span class="st">'14.21'</span>),</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'14.53'</span>, <span class="st">'15.08'</span>),</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'15.09'</span>, <span class="st">'15.42'</span>),</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'15.43'</span>, <span class="st">'16.00'</span>),</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'16.03'</span>, <span class="st">'16.43'</span>),</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'16.45'</span>, <span class="st">'16.47'</span>),</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'16.53'</span>, <span class="st">'16.56'</span>)]</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>calculate_times(used_to_date, times)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Time spent today: 211m, or 3h 31m
Total used to date: 243m, or 4h 3m
Time remaining: 2157m, or 35h 57m
Used 10.1% of 40 hours max</code></pre>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/pythonhealthdatascience\.github\.io\/stars-reproduce-kim-2021\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p><a href="https://github.com/pythonhealthdatascience"><img src="https://raw.githubusercontent.com/pythonhealthdatascience/stars-logo/main/stars_logo_blue_text.png" class="img-fluid" alt="STARS" width="300"></a></p>
</div>   
    <div class="nav-footer-center">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
    <a class="nav-link" href="../../../CHANGELOG.md">
<p>Changelog</p>
</a>
  </li>  
    <li class="nav-item">
    <a class="nav-link" href="../../../quarto_site/license.html">
<p>License</p>
</a>
  </li>  
    <li class="nav-item">
    <a class="nav-link" href="../../../CONTRIBUTING.md">
<p>Contributing</p>
</a>
  </li>  
</ul>
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/pythonhealthdatascience/stars-reproduce-kim-2021/edit/main/logbook/posts/2024_07_29/index.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/pythonhealthdatascience/stars-reproduce-kim-2021/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/pythonhealthdatascience/stars-reproduce-kim-2021/">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>




</body></html>